<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Via Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }
    </style>
</head>

<body class="p-6 h-screen flex flex-col gap-6 overflow-hidden">

    <div class="glass-panel p-6 flex flex-col items-center justify-center gap-4 shrink-0">
        <h1 class="text-xl font-bold text-blue-400">Điều khiển Trình duyệt</h1>
        <p class="text-sm text-slate-400 text-center max-w-md">
            Trình duyệt này đang chạy độc lập. Bạn có thể tương tác với nó thông qua các nút bấm bên dưới.
        </p>

        <div class="flex flex-wrap gap-4 justify-center mt-2">
            <button onclick="takeScreenshot()"
                class="flex items-center gap-2 px-5 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium transition-all shadow-lg shadow-blue-900/40">
                <i class="ri-camera-fill"></i> Chụp màn hình
            </button>
            <button onclick="reloadPage()"
                class="flex items-center gap-2 px-5 py-2.5 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg font-medium transition-all border border-slate-600">
                <i class="ri-refresh-line"></i> Tải lại trang
            </button>
        </div>
    </div>

    <!-- Khu vực hiển thị kết quả -->
    <div class="glass-panel flex-1 p-4 flex flex-col min-h-0">
        <div class="flex items-center justify-between mb-3 px-2">
            <h3 class="font-bold text-slate-300">Kết quả / Log</h3>
            <button onclick="document.getElementById('log-content').innerHTML = ''"
                class="text-xs text-slate-500 hover:text-slate-300">Xóa log</button>
        </div>
        <div id="log-content"
            class="flex-1 overflow-y-auto bg-black/40 rounded-lg p-4 font-mono text-xs text-green-400 space-y-2">
            <div>> Sẵn sàng...</div>
        </div>
    </div>

    <script>
        let ipcRenderer;
        try {
            const electron = require('electron');
            ipcRenderer = electron.ipcRenderer;
        } catch (e) {
            console.error("Require electron failed:", e);
            document.addEventListener('DOMContentLoaded', () => {
                log("LỖI: Không thể tải module Electron. Kiểm tra Node Integration.", 'error');
                log("Chi tiết lỗi: " + e.message, 'error');
            });
        }

        // Lấy params từ URL
        const urlParams = new URLSearchParams(window.location.search);
        const TAB_ID = urlParams.get('tabId');
        const UID = urlParams.get('uid');

        function log(msg, type = 'info') {
            const el = document.getElementById('log-content');
            const div = document.createElement('div');
            const color = type === 'error' ? 'text-red-400' : (type === 'img' ? 'text-blue-300' : 'text-green-400');
            div.className = `${color}`;

            if (type === 'img') {
                div.innerHTML = `> Đã chụp màn hình:<br><img src="${msg}" class="mt-2 rounded border border-slate-600 max-w-full h-auto shadow-lg">`;
            } else {
                div.innerText = `> ${msg}`;
            }

            el.appendChild(div);
            el.scrollTop = el.scrollHeight;
        }

        async function takeScreenshot() {
            if (!TAB_ID) {
                log("Lỗi: Không tìm thấy Tab ID", 'error');
                return;
            }

            log("Đang yêu cầu chụp màn hình...");
            try {
                const result = await ipcRenderer.invoke('puppeteer-action', {
                    tabId: TAB_ID,
                    action: 'screenshot'
                });

                if (result.success) {
                    const imgData = `data:image/png;base64,${result.data}`;
                    log(imgData, 'img');
                } else {
                    log(`Lỗi: ${result.msg}`, 'error');
                }
            } catch (err) {
                log(`Lỗi IPC: ${err.message}`, 'error');
            }
        }

        async function reloadPage() {
            if (!TAB_ID) {
                log("Lỗi: Không tìm thấy Tab ID", 'error');
                return;
            }

            log("Đang tải lại trang...");
            try {
                const result = await ipcRenderer.invoke('puppeteer-action', {
                    tabId: TAB_ID,
                    action: 'reload'
                });

                if (result.success) {
                    log("Đã tải lại trang thành công!", 'success');
                } else {
                    log(`Lỗi: ${result.msg}`, 'error');
                }
            } catch (err) {
                log(`Lỗi IPC: ${err.message}`, 'error');
            }
        }

        // Tự động log thông tin khi load
        log(`Kết nối thành công với Tab ID: ${TAB_ID}`);
        log(`UID: ${UID}`);

    </script>
</body>

</html>